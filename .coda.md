# CODA Repository Overview

> Auto-generated by CODA. Keep in sync with the codebase.

## Project Overview

ExcaliWeb is a self-hosted web application that wraps the Excalidraw whiteboard editor with persistent file storage and folder management. It provides a React SPA frontend with a sidebar for browsing, creating, renaming, and deleting `.excalidraw` files and folders, backed by an Express REST API that performs CRUD operations on a configurable data directory. The application supports workspace switching, auto-saving (every 10 seconds and via `Ctrl+S`/`Cmd+S`), and is designed for single-container Docker deployment with nginx as a reverse proxy and supervisord for process management.

## Architecture

```
┌──────────────────────────────────────────────────────┐
│                   Docker Container                   │
│                                                      │
│  ┌───────────┐    ┌────────────┐    ┌────────────┐  │
│  │   nginx   │───>│  React SPA │    │  Express   │  │
│  │  (port 80)│    │  (static)  │    │   API      │  │
│  │           │    └────────────┘    │ (port 3001)│  │
│  │           │         /api/*       └─────┬──────┘  │
│  │           │──────────────────────────>│          │
│  └───────────┘                           │          │
│                                 ┌────────▼────────┐ │
│                                 │  FileSystem     │ │
│                                 │  Service        │ │
│                                 │  (data/)        │ │
│                                 └─────────────────┘ │
│                                                      │
│  supervisord manages nginx + node processes          │
│  entrypoint.sh handles PUID/PGID user mapping       │
└──────────────────────────────────────────────────────┘
```

- **Frontend**: React 19 SPA built with Vite, embedding the `@excalidraw/excalidraw` editor component
- **Backend**: Express 4 REST API with file/folder CRUD and workspace management
- **Production**: nginx serves static assets and proxies `/api/*` to the Node.js backend
- **Process management**: supervisord orchestrates nginx and Node inside a single container
- **User mapping**: entrypoint.sh maps PUID/PGID via `su-exec` to match host user for correct file permissions

## Core Abstractions

### Server

| Abstraction | Location | Responsibility |
|---|---|---|
| `FileSystemService` | `server/src/services/fileSystem.ts` | Core business logic — workspace state, path validation (directory traversal prevention), file/folder CRUD, recursive file tree listing |
| `FileInfo` / `FolderInfo` | `server/src/types/index.ts` | Data structures for files and folder trees; `FolderInfo` contains recursive `children` arrays |
| `ExcalidrawFileData` | `server/src/types/index.ts` | Schema for `.excalidraw` JSON files (type, version, elements, appState, files) |
| Workspace routes | `server/src/routes/workspace.ts` | Default workspace config, workspace selection with DATA_DIR validation, file tree retrieval |
| Files routes | `server/src/routes/files.ts` | File CRUD (create, read, update, delete), folder CRUD, file rename |
| Filesystem routes | `server/src/routes/filesystem.ts` | Directory browsing for workspace selection modal (list, home, common dirs) |
| Error handler | `server/src/middleware/errorHandler.ts` | Centralized Express error middleware and request logging |

### Client

| Abstraction | Location | Responsibility |
|---|---|---|
| `App` | `client/src/App.tsx` | Root component — workspace initialization, file selection, editor/sidebar orchestration, dirty state tracking via content fingerprinting |
| `Editor` | `client/src/components/Editor.tsx` | Excalidraw editor wrapper — renders drawing canvas, forwards change events |
| `Sidebar` | `client/src/components/Sidebar.tsx` | File tree navigation — hierarchical folder display, file/folder context actions |
| `Modal` | `client/src/components/Modal.tsx` | Create file, create folder, and rename modals |
| `WorkspaceModal` | `client/src/components/WorkspaceModal.tsx` | Directory browser for workspace selection |
| `useAutoSave` | `client/src/hooks/useAutoSave.ts` | Custom hook — 10-second interval save, `Ctrl+S`/`Cmd+S` capture-phase handler, beforeunload guard |
| API client | `client/src/utils/api.ts` | Typed fetch wrappers for all backend endpoints, base64url file ID encoding |
| Storage utils | `client/src/utils/storage.ts` | localStorage persistence for workspace path |
| File tree utils | `client/src/utils/fileTreeUtils.ts` | Helpers — file counting, searching, tree flattening |

## Directory Guide

| Directory | Purpose |
|---|---|
| `client/` | React frontend package (Vite + TypeScript) |
| `client/src/components/` | UI components — Editor, Sidebar, Modal, WorkspaceModal |
| `client/src/hooks/` | Custom React hooks — auto-save logic |
| `client/src/utils/` | Client utilities — API client, file tree helpers, localStorage |
| `server/` | Express backend package (TypeScript) |
| `server/src/routes/` | API route handlers — workspace, files, filesystem |
| `server/src/services/` | Backend business logic — filesystem service |
| `server/src/middleware/` | Express middleware — error handler, request logger |
| `server/src/types/` | Shared TypeScript type definitions |
| `docker/` | Docker infrastructure — Dockerfile, compose, nginx config, supervisord, entrypoint |
| `data/` | Default workspace directory for `.excalidraw` files (volume-mounted in Docker) |
| `specs/` | Design specifications and feature ideas |

## Tech Stack

| Category | Details |
|---|---|
| Languages | TypeScript, CSS, HTML |
| Frontend | React 19, Vite 7, @excalidraw/excalidraw 0.18 |
| Backend | Express 4, cors, Node.js 20 |
| Linting | ESLint 9 with typescript-eslint, react-hooks, react-refresh plugins |
| Build | Vite (client), tsc (server), tsx (dev server) |
| Infrastructure | Docker (multi-stage, node:20-alpine), nginx, supervisord, su-exec, Make |

## Development Workflow

### Install dependencies

```bash
npm run install:all
```

### Run in development mode

```bash
# Start both client and server
npm run dev:all

# Or separately:
npm run dev          # Client only (Vite dev server, port 5173)
npm run dev:server   # Server only (tsx watch, port 3001, uses ./data)
```

### Build

```bash
npm run build:all    # Build both client and server
npm run build        # Client only (tsc + vite build)
npm run build:server # Server only (tsc)
```

### Lint

```bash
npm run lint         # ESLint on client
```

### Docker deployment

```bash
make build           # Build Docker image
make deploy          # Build and run container (port 5174, auto-detects UID/GID)
make logs            # View container logs (follow mode)
make status          # Check container status
make clean           # Stop and remove container and image
make help            # Show all available commands
```

## Key Patterns

- **Auto-save**: The client uses `useAutoSave` hook with a 10-second interval, `Ctrl+S`/`Cmd+S` capture-phase handler, and `beforeunload` guard
- **Content fingerprinting**: `App.tsx` uses a lightweight fingerprint (element count + version sum) to detect actual content changes, avoiding false dirty flags from Excalidraw's frequent `onChange` calls
- **Workspace management**: Users can switch between workspaces; the server validates workspace paths against `DATA_DIR` and resolves them to absolute paths
- **File ID encoding**: File paths are encoded as base64url strings for use in REST URL parameters
- **File tree**: The sidebar renders a recursive `FolderInfo` tree built by `listExcalidrawFilesRecursive`, sorted folders-first then alphabetically
- **Path validation**: The filesystem service validates all paths are within the workspace and `DATA_DIR` to prevent directory traversal
- **Centralized error handling**: Express middleware provides consistent error responses with optional details in development mode
- **PUID/PGID mapping**: The Docker entrypoint maps container user/group IDs via `su-exec` to match the host for correct file permissions
- **Root-level npm scripts**: The root `package.json` delegates to `client/` and `server/` sub-packages via `cd` and `--prefix`

## Coding Standards

- TypeScript strict mode for both client and server
- ESLint with typescript-eslint for client-side code
- No test framework currently configured
- Conventional commit messages (feat:, fix:, refactor:, docs:, chore:)
