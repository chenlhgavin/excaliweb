# CODA Repository Overview

> Auto-generated by CODA. Keep in sync with the codebase.

## Project Overview

Excaliweb is a self-hosted web application that provides a file-manager interface around the Excalidraw whiteboard drawing engine. It lets users browse a server-side workspace directory, create/rename/delete `.excalidraw` files and folders, open drawings in an embedded Excalidraw editor, and auto-save changes back to the filesystem. The core value proposition is giving teams a lightweight, self-hosted alternative to Excalidraw's cloud offering with direct filesystem-based persistence and no external database.

## Architecture Overview

```
┌─────────────────────────────────────────────────────┐
│                    Browser (SPA)                     │
│                                                      │
│  ┌────────────┐  ┌──────────┐  ┌─────────────────┐  │
│  │  App.tsx    │  │ Sidebar  │  │ WorkspaceModal  │  │
│  │ (state hub) │  │ (tree)   │  │ (dir browser)   │  │
│  └─────┬──────┘  └────┬─────┘  └───────┬─────────┘  │
│        │               │                │             │
│  ┌─────▼──────┐  ┌────▼─────┐          │             │
│  │  Editor    │  │ Modal    │          │             │
│  │(Excalidraw)│  │(dialogs) │          │             │
│  └────────────┘  └──────────┘          │             │
│        │               │                │             │
│  ┌─────▼───────────────▼────────────────▼──────────┐ │
│  │              utils/api.ts (HTTP client)          │ │
│  └──────────────────────┬──────────────────────────┘ │
└─────────────────────────┼───────────────────────────┘
                          │  JSON / HTTP
                          ▼
┌─────────────────────────────────────────────────────┐
│                Express.js Server                     │
│                                                      │
│  ┌──────────────────────────────────────────┐        │
│  │           Routes Layer                    │        │
│  │  files.ts  │  workspace.ts  │ filesystem.ts│       │
│  └─────┬──────┴───────┬────────┴──────┬──────┘       │
│        │               │               │              │
│  ┌─────▼───────────────▼───────────────▼──────────┐  │
│  │         fileSystem Service                      │  │
│  │  (workspace state, path validation, fs I/O)     │  │
│  └─────────────────────┬──────────────────────────┘  │
│                        │                              │
│  ┌─────────────────────▼──────────────────────────┐  │
│  │           Node.js fs.promises                   │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  ┌────────────────────────────────────────────────┐  │
│  │  Middleware: errorHandler, requestLogger        │  │
│  └────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

**Client (React SPA):** App.tsx is the state hub, coordinating Sidebar (file tree navigation), Editor (Excalidraw wrapper), Modal (create/rename dialogs), and WorkspaceModal (directory browser). All HTTP communication goes through `utils/api.ts`.

**Server (Express.js):** Routes handle HTTP concerns and input validation. The `fileSystem` service encapsulates all business logic — workspace management, path security, and filesystem I/O. Middleware provides centralized error handling and request logging.

**Dependency direction:** Client depends on server via HTTP. Routes depend on the fileSystem service. The fileSystem service depends only on Node.js `fs.promises`.

## Interface Design

| Interface | Module | Purpose |
|-----------|--------|---------|
| `FileInfo` | `server/src/types/index.ts` | Represents a `.excalidraw` file: name, path, parentPath. Core data contract between client and server. |
| `FolderInfo` | `server/src/types/index.ts` | Recursive directory node containing `(FileInfo \| FolderInfo)[]` children. Defines the file tree structure. |
| `FileTreeItem` | `server/src/types/index.ts` | Union type `FileInfo \| FolderInfo`. Used with `isFolder()` type guard for tree traversal. |
| `ExcalidrawFileData` | `server/src/types/index.ts` | Schema for `.excalidraw` file content (type, version, source, elements, appState, files). Drawing persistence contract. |
| `SelectWorkspaceRequest` | `server/src/types/index.ts` | `{ path: string }` — payload for workspace selection endpoint. |
| `SelectWorkspaceResponse` | `server/src/types/index.ts` | `{ workspacePath: string, rootFolder: FolderInfo }` — response after selecting a workspace. |
| `CreateFileRequest` | `server/src/types/index.ts` | `{ name: string, parentPath: string }` — payload for file/folder creation. |
| `SaveFileRequest` | `server/src/types/index.ts` | `{ content: ExcalidrawFileData }` — payload for file save (PUT). |
| `RenameFileRequest` | `server/src/types/index.ts` | `{ newName: string }` — payload for file rename (PATCH). |
| `ErrorResponse` | `server/src/types/index.ts` | `{ error: string, details?: string }` — standard error response shape. |
| `SidebarProps` | `client/src/components/Sidebar.tsx` | Callback interface for all sidebar interactions (file select, folder create, delete, rename). |
| `EditorProps` | `client/src/components/Editor.tsx` | `{ fileKey, data, onChange }` — Editor component contract for Excalidraw integration. |

No new interfaces were introduced by the `update-readme` feature (documentation-only change).

## Data Flow

### Workspace Initialization

```
App mount
  │
  ▼
getDefaultWorkspace() ──GET /api/workspace/default──▶ server env check
  │
  ├─ default exists ──▶ selectWorkspace(path) ──POST /api/workspace/select──▶ set workspace, scan dir
  │                                                                           return FolderInfo tree
  ├─ localStorage has saved path ──▶ getWorkspace() ──GET /api/workspace──▶ restore session
  │
  └─ neither ──▶ open WorkspaceModal ──▶ user browses dirs ──▶ selectWorkspace()
```

### File Open → Edit → Save

```
Sidebar click ──▶ handleSelectFile()
  │
  ├─ if dirty ──▶ PUT /api/files/:fileId (auto-save current)
  │
  ▼
GET /api/files/:fileId
  │ server: decode base64url → validatePath → fs.readFile → JSON.parse
  ▼
Set excalidrawData state ──▶ Editor remounts with initialData
  │
  ▼
User draws ──▶ Excalidraw onChange ──▶ isDirty = true
  │
  ├─ useAutoSave (10s interval) ──▶ PUT /api/files/:fileId
  ├─ Ctrl+S ──▶ immediate save
  └─ beforeunload ──▶ save attempt
```

### File CRUD

```
User action (context menu) ──▶ Modal opens
  │
  ▼
Confirm ──▶ API call (POST create / DELETE / PATCH rename)
  │ server: validate input → fileSystem service → fs operation
  ▼
Refresh file tree ──▶ GET /api/workspace ──▶ update Sidebar
```

No data flows were modified by the `update-readme` feature (documentation-only change).

## Core Data Structures

- **FileInfo** — `{ name: string, path: string, parentPath: string }` — leaf node in the file tree
- **FolderInfo** — `{ name: string, path: string, parentPath: string, children: (FileInfo | FolderInfo)[], isExpanded?: boolean }` — recursive directory node
- **FileTreeItem** — `FileInfo | FolderInfo` — union type with `isFolder()` type guard
- **ExcalidrawFileData** — `{ type: "excalidraw", version: number, source: string, elements: readonly any[], appState?: Record<string, any>, files?: Record<string, any> }` — the Excalidraw native file format, persisted as JSON
- **ErrorResponse** — `{ error: string, details?: string }` — standard server error shape
- **File IDs** — base64url-encoded relative file paths, used as URL-safe identifiers in REST endpoints

Serialization: All data exchanged as JSON over HTTP. Files stored as pretty-printed JSON on disk.

## Module Guide

| Directory | Purpose |
|-----------|---------|
| `client/src/` | React SPA entry point, App root component |
| `client/src/components/` | UI components: Editor, Sidebar, Modal, WorkspaceModal |
| `client/src/hooks/` | Custom hooks (useAutoSave) |
| `client/src/utils/` | API client, file tree helpers, localStorage persistence |
| `client/src/types.ts` | Client-side type definitions |
| `server/src/` | Express server entry point (`server.ts`) |
| `server/src/routes/` | REST route handlers: files, workspace, filesystem |
| `server/src/services/` | Business logic: fileSystem service |
| `server/src/middleware/` | Express middleware: error handler, request logger |
| `server/src/types/` | Shared TypeScript interfaces |
| `tests/` | Playwright end-to-end tests |
| `test-drawings/` | Sample `.excalidraw` files for testing |
| `test-results/` | Playwright test output artifacts |
| `specs/` | Feature specifications and design documents |

Docker and nginx configuration files (`Dockerfile`, `docker-compose.yml`, `nginx.conf`, `supervisord.conf`, `Makefile`) live at the repository root.

## Tech Stack & Dependencies

| Category | Technology | Role |
|----------|-----------|------|
| Language | TypeScript (~5.9 client, ~5.3 server) | Primary language for both client and server |
| Frontend Framework | React 19 | SPA UI framework |
| Drawing Engine | @excalidraw/excalidraw ^0.18 | Whiteboard editor component |
| Backend Framework | Express.js ^4.18 | REST API server |
| Bundler | Vite ^7.2 | Client development server and production bundler |
| Server Dev Runner | tsx ^4.7 | TypeScript execution with watch mode |
| E2E Testing | Playwright ^1.58 | Browser-based end-to-end tests |
| Linting | ESLint ^9.39 | Client-side code linting |
| HTTP Middleware | cors ^2.8 | Cross-origin request support |
| Production | nginx + supervisord + Docker | Reverse proxy, process management, containerization |

## Development Workflow

```bash
# Install all dependencies
npm run install:all

# Development (client + server in parallel)
npm run dev:all

# Development (separate terminals)
npm run dev          # client only (Vite dev server, port 5173)
npm run dev:server   # server only (tsx watch, port 3001)

# Build
npm run build:all    # build both client and server

# Lint
npm run lint         # ESLint on client

# Type check
cd client && npx tsc -b --noEmit
cd server && npx tsc --noEmit

# Test (e2e)
npx playwright test

# Docker
make build           # build Docker image
make deploy          # build and run container (port 5174)
make status          # check container health
make logs            # follow container logs
make clean           # stop and remove container
```

## Key Patterns & Conventions

- **Layered architecture**: Routes (HTTP) → Services (business logic) → Filesystem (I/O). No direct `fs` calls from route handlers.
- **Path security**: All file paths validated against workspace boundary to prevent directory traversal. When `DATA_DIR` is set, all operations are further restricted to that directory. Base64url encoding used for file IDs in URLs.
- **Single-tenant model**: One workspace active at a time, held in module-level state. No user sessions or multi-tenancy.
- **Error handling**: Server returns `{ error: string, details?: string }` JSON with appropriate HTTP status codes. Client catches errors and displays via `alert()`. No custom error classes.
- **Auto-save**: Client-side `useAutoSave` hook fires every 10 seconds when dirty, plus Ctrl+S and beforeunload handlers.
- **State management**: React-local state in App.tsx (useState/useRef). No external state library.
- **File format**: Native `.excalidraw` JSON format. No custom serialization layer.
- **Module system**: ES modules throughout (`"type": "module"` in all package.json files).
- **Monorepo structure**: Root package.json orchestrates client/ and server/ subdirectories via `cd` scripts. No workspace manager (npm workspaces, turborepo, etc.).
