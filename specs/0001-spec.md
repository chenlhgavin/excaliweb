# ExcaliWeb - Excalidraw 文件管理器

## 1. 概述

ExcaliWeb 是一个基于 Web 的 Excalidraw 文件管理和编辑应用。用户可以指定本地目录，浏览和编辑目录中的 `.excalidraw` 文件，实现类似本地编辑器的体验。

## 2. 技术栈

- **前端框架**: React + TypeScript
- **绘图引擎**: [Excalidraw SDK](https://github.com/excalidraw/excalidraw)
- **文件系统**: File System Access API (纯前端方案)
- **构建工具**: Vite

## 3. 核心功能

### 3.1 目录管理

#### 3.1.1 打开目录
- 应用启动时检查是否有上次打开的目录记录
- 如果有记录且权限有效，自动加载该目录下的文件列表
- 如果没有记录或权限失效，提示用户选择一个目录
- 目录句柄通过 IndexedDB 持久化存储

#### 3.1.2 切换目录
- 用户可以随时切换到其他目录
- 切换前自动保存当前文件的修改

### 3.2 文件列表（侧边栏）

#### 3.2.1 文件展示
- 显示当前目录下所有 `.excalidraw` 文件
- 文件按名称排序
- 显示文件名（不含扩展名）
- 当前选中的文件高亮显示
- 已修改未保存的文件显示标记（如圆点）

#### 3.2.2 文件操作
- **新建文件**: 在当前目录下创建新的 `.excalidraw` 文件
- **删除文件**: 删除选中的文件（需确认）

### 3.3 文件编辑（主内容区）

#### 3.3.1 文件加载
- 点击侧边栏文件后，在主内容区加载并显示 Excalidraw 画布
- 使用 Excalidraw SDK 渲染文件内容

#### 3.3.2 文件切换
- 切换到新文件时，自动保存当前文件（如果有修改）
- 加载新文件内容到画布

#### 3.3.3 文件保存
- **手动保存**: 支持快捷键 `Ctrl/Cmd + S` 保存
- **自动保存**: 每 10 秒检测一次，如有修改则自动保存
- **切换保存**: 切换文件或关闭应用时自动保存

## 4. 界面设计

```
+------------------+----------------------------------------+
|                  |                                        |
|    侧边栏         |              主内容区                   |
|    (文件列表)     |           (Excalidraw 画布)            |
|                  |                                        |
|  [打开目录]       |                                        |
|  [新建文件]       |                                        |
|                  |                                        |
|  ----------------+                                        |
|  📄 diagram1     |                                        |
|  📄 diagram2 ●   |                                        |
|  📄 flowchart    |                                        |
|                  |                                        |
|                  |                                        |
|                  |                                        |
+------------------+----------------------------------------+
```

### 4.1 侧边栏
- 宽度: 250px
- 顶部: 目录操作按钮（打开目录、新建文件）
- 中部: 文件列表
- 文件项: 支持右键菜单（删除）

### 4.2 主内容区
- 占据剩余宽度
- 嵌入 Excalidraw 组件
- 无文件选中时显示欢迎提示

## 5. File System Access API 接口

### 5.1 目录操作

```typescript
// 打开目录选择器
const dirHandle = await window.showDirectoryPicker();

// 遍历目录文件
for await (const entry of dirHandle.values()) {
  if (entry.kind === 'file' && entry.name.endsWith('.excalidraw')) {
    // 处理文件
  }
}
```

### 5.2 文件操作

```typescript
// 读取文件
const fileHandle = await dirHandle.getFileHandle('diagram.excalidraw');
const file = await fileHandle.getFile();
const content = await file.text();

// 保存文件
const writable = await fileHandle.createWritable();
await writable.write(content);
await writable.close();

// 创建文件
const newHandle = await dirHandle.getFileHandle('new.excalidraw', { create: true });

// 删除文件
await dirHandle.removeEntry('diagram.excalidraw');
```

### 5.3 数据结构

#### 文件信息
```typescript
interface FileInfo {
  name: string;           // 文件名（不含扩展名）
  handle: FileSystemFileHandle;  // 文件句柄
}
```

#### 文件内容
```typescript
interface ExcalidrawFile {
  type: "excalidraw";
  version: number;
  source: string;
  elements: ExcalidrawElement[];
  appState?: Partial<AppState>;
  files?: BinaryFiles;
}
```

## 6. 状态管理

### 6.1 应用状态
```typescript
interface AppState {
  directoryHandle: FileSystemDirectoryHandle | null;  // 目录句柄
  files: FileInfo[];                // 文件列表
  currentFile: FileInfo | null;     // 当前打开的文件
  isDirty: boolean;                 // 当前文件是否有未保存的修改
  excalidrawData: ExcalidrawFile | null; // 当前文件的 Excalidraw 数据
}
```

## 7. 用户交互流程

### 7.1 首次使用
1. 打开应用
2. 点击「打开目录」按钮
3. 浏览器弹出目录选择器，用户选择目录
4. 授权访问后，侧边栏显示文件列表
5. 点击文件开始编辑

### 7.2 日常使用
1. 打开应用，尝试恢复上次的目录权限
2. 如果权限有效，自动加载文件列表
3. 如果权限失效，提示重新选择目录
4. 从侧边栏选择文件编辑
5. 编辑过程中自动保存

### 7.3 文件切换
1. 点击侧边栏其他文件
2. 系统自动保存当前文件（如有修改）
3. 加载新文件内容

## 8. 边界情况处理

### 8.1 错误处理
- 目录权限失效：提示用户重新选择目录
- 文件读取失败：显示错误提示，保持在当前文件
- 文件保存失败：显示错误提示，保留修改状态，允许重试

### 8.2 并发处理
- 自动保存与手动保存冲突：使用防抖，避免重复保存
- 文件外部修改：暂不处理，以应用内状态为准

## 9. 非功能性需求

### 9.1 性能
- 文件列表加载时间 < 500ms
- 文件切换响应时间 < 200ms
- 自动保存不影响编辑体验

### 9.2 兼容性
- 支持 Chrome 86+、Edge 86+、Opera 72+
- 支持 `.excalidraw` 标准文件格式
- 不支持 Firefox 和 Safari（File System Access API 限制）

## 10. 未来扩展（不在当前版本）

- 文件夹嵌套支持
- 文件搜索功能
- 文件重命名
- 多标签页编辑
- 导出为 PNG/SVG
- 版本历史
